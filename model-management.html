<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>型号管理系统 - 防务连接器</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Sortable.js -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* 基础样式 */
        [x-cloak] { display: none !important; }
        
        ::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        /* 树形结构 */
        .tree-children {
            position: relative;
            margin-left: 16px;
        }
        .tree-children::before {
            content: '';
            position: absolute;
            left: -10px;
            top: 0;
            bottom: 12px;
            width: 1px;
            background: #e2e8f0;
        }
        
        .tree-node {
            position: relative;
        }
        .tree-node::before {
            content: '';
            position: absolute;
            left: -10px;
            top: 14px;
            width: 10px;
            height: 1px;
            background: #e2e8f0;
        }
        
        .tree-item {
            margin-bottom: 1px;
        }
        
        .tree-actions {
            opacity: 0;
            transition: opacity 0.15s;
        }
        .tree-item:hover .tree-actions {
            opacity: 1;
        }
        
        /* 内联编辑 */
        .inline-input {
            background: white;
            border: 2px solid #3b82f6;
            border-radius: 3px;
            padding: 1px 4px;
            font-size: 13px;
            outline: none;
            width: 100%;
        }
        
        /* 系列选中状态 */
        .series-selected {
            background: #dbeafe !important;
            border-left: 3px solid #3b82f6;
        }
        
        /* 表格容器 - 支持横向滚动 */
        .table-container {
            overflow-x: auto;
            overflow-y: hidden;
            position: relative;
        }
        
        /* 表格紧凑样式 */
        .compact-table {
            table-layout: auto;
            min-width: 100%;
        }
        
        .compact-table th,
        .compact-table td {
            padding: 6px 8px;
            font-size: 13px;
            white-space: nowrap;
        }
        
        /* 列宽调整手柄 */
        .resize-handle {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            cursor: col-resize;
            background: transparent;
            z-index: 10;
        }
        .resize-handle:hover {
            background: #3b82f6;
        }
        
        .compact-input {
            padding: 2px 4px;
            font-size: 13px;
            border: 1px solid transparent;
            border-radius: 3px;
            width: 100%;
            background: transparent;
            min-width: 60px;
        }
        .compact-input:hover {
            border-color: #cbd5e1;
            background: white;
        }
        .compact-input:focus {
            border-color: #3b82f6;
            background: white;
            outline: none;
        }
        
        /* 列标题拖拽 */
        .col-header {
            cursor: move;
            user-select: none;
            position: relative;
            min-width: 80px;
        }
        .col-header:hover {
            background: #f1f5f9;
        }
        .col-header.sortable-ghost {
            opacity: 0.4;
            background: #e0f2fe;
        }
        
        /* 筛选按钮 */
        .filter-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .col-header:hover .filter-btn {
            opacity: 1;
        }
        
        /* 右键菜单 */
        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 9999;
            min-width: 140px;
        }
        .context-menu-item {
            padding: 8px 12px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .context-menu-item:hover {
            background: #f1f5f9;
        }
        .context-menu-item:first-child {
            border-radius: 6px 6px 0 0;
        }
        .context-menu-item:last-child {
            border-radius: 0 0 6px 6px;
        }
        .context-menu-divider {
            height: 1px;
            background: #e2e8f0;
            margin: 4px 0;
        }
        
        /* 图片模态框 */
        .image-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: zoom-out;
        }
        .image-modal img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }
        
        /* 改型列表 */
        .variant-row {
            display: grid;
            grid-template-columns: 1fr 120px 24px;
            gap: 8px;
            padding: 6px 8px;
            border-bottom: 1px solid #f1f5f9;
            align-items: center;
        }
        .variant-row:hover {
            background: #f8fafc;
        }
        
        /* 侧边栏折叠 */
        .sidebar-collapsed {
            width: 40px !important;
            min-width: 40px !important;
        }
        .sidebar-collapsed .tree-content,
        .sidebar-collapsed .sidebar-header-text {
            display: none;
        }
        
        /* 筛选下拉 */
        .filter-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            min-width: 120px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 100;
            max-height: 250px;
            overflow-y: auto;
        }
        
        /* 拖动时的行样式 */
        .sortable-ghost {
            opacity: 0.4;
            background: #e0f2fe;
        }
        .sortable-drag {
            cursor: move;
        }
    </style>
<base target="_blank">
</head>
<body class="bg-slate-50 text-slate-700 h-screen overflow-hidden text-[13px]" 
      x-data="modelManager()" 
      x-init="init()" 
      @click="hideContextMenu(); closeAllFilters()"
      @contextmenu.prevent="hideContextMenu()">

    <!-- 顶部导航 -->
    <header class="bg-white border-b border-slate-200 h-12 flex items-center px-4 shadow-sm z-20">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center text-white shadow-md">
                <i class="fas fa-layer-group text-sm"></i>
            </div>
            <h1 class="text-base font-bold text-slate-800">型号管理系统</h1>
        </div>
        <div class="ml-auto flex items-center gap-2">
            <button @click="exportCSV()" class="px-3 py-1.5 bg-slate-100 hover:bg-slate-200 rounded text-xs font-medium transition-colors flex items-center gap-1.5">
                <i class="fas fa-file-csv"></i> 导出CSV
            </button>
            <label class="px-3 py-1.5 bg-blue-500 hover:bg-blue-600 text-white rounded text-xs font-medium transition-colors flex items-center gap-1.5 cursor-pointer">
                <i class="fas fa-file-import"></i> 导入CSV
                <input type="file" @change="importCSV($event)" accept=".csv" class="hidden">
            </label>
        </div>
    </header>

    <!-- 主体内容 -->
    <div class="flex h-[calc(100vh-48px)]">
        
        <!-- 第一部分：树形型号分类 -->
        <aside :class="sidebarCollapsed ? 'sidebar-collapsed' : 'w-64'" 
               class="bg-white border-r border-slate-200 flex flex-col shadow-sm z-10 transition-all duration-200 relative">
            
            <div class="h-10 border-b border-slate-100 flex items-center justify-between px-2 bg-slate-50/50">
                <span class="sidebar-header-text font-semibold text-slate-700 text-xs flex items-center gap-1.5 px-1">
                    <i class="fas fa-sitemap text-blue-500"></i> 型号分类
                </span>
                <button @click="sidebarCollapsed = !sidebarCollapsed" 
                        class="w-7 h-7 hover:bg-slate-200 rounded flex items-center justify-center text-slate-500 transition-all"
                        :class="sidebarCollapsed ? 'mx-auto' : ''">
                    <i class="fas fa-chevron-left text-xs" :class="sidebarCollapsed ? 'rotate-180' : ''"></i>
                </button>
            </div>
            
            <div class="tree-content flex-1 overflow-y-auto p-1.5" id="categoryTree">
                <!-- 递归树形渲染 -->
                <template x-for="(item, index) in categories" :key="item.id">
                    <div x-html="renderTreeItem(item, index, categories)"></div>
                </template>
                
                <!-- 根级添加 -->
                <div class="mt-2 pt-2 border-t border-slate-100 px-1">
                    <button @click="addRootFolder()" class="w-full py-1.5 bg-blue-50 hover:bg-blue-100 text-blue-600 rounded text-xs font-medium flex items-center justify-center gap-1 transition-colors">
                        <i class="fas fa-folder-plus text-[10px]"></i> 新增领域
                    </button>
                </div>
            </div>
        </aside>

        <!-- 第二部分：列表型号展示 -->
        <main class="flex-1 flex flex-col bg-slate-50 min-w-0 overflow-hidden">
            <div class="p-3 flex-1 overflow-auto">
                <!-- 面包屑 -->
                <div class="mb-2 flex items-center gap-2 text-xs text-slate-500">
                    <span class="font-medium">型号管理</span>
                    <i class="fas fa-chevron-right text-[10px]"></i>
                    <span x-show="selectedSeries" class="flex items-center gap-1">
                        <span x-text="breadcrumbPath" class="font-medium text-slate-700"></span>
                    </span>
                    <span x-show="!selectedSeries" class="text-slate-400">请选择系列</span>
                </div>

                <!-- 型号列表 -->
                <div x-show="selectedSeries" class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
                    <div class="table-container" id="tableContainer">
                        <table class="compact-table" id="modelTable">
                            <thead class="bg-slate-50 border-b border-slate-200">
                                <tr id="tableHeader">
                                    <th class="w-10 text-center" style="min-width: 40px;">
                                        <i class="fas fa-grip-lines text-slate-400 text-xs"></i>
                                    </th>
                                    <th class="font-semibold text-slate-600" style="min-width: 120px; width: 150px;">系列型号</th>
                                    <template x-for="(col, index) in dynamicColumns" :key="col.name">
                                        <th class="col-header font-semibold text-slate-600 relative group" 
                                            :data-col-index="index"
                                            :style="`min-width: ${col.width || 100}px; width: ${col.width || 100}px;`">
                                            <div class="flex items-center justify-between gap-1">
                                                <span x-text="col.name" class="flex-1 truncate"></span>
                                                <button @click.stop="toggleFilter(col.name)" class="filter-btn text-slate-400 hover:text-blue-500 p-0.5">
                                                    <i class="fas fa-filter text-[10px]"></i>
                                                </button>
                                            </div>
                                            <!-- 筛选下拉 -->
                                            <div x-show="activeFilter === col.name" x-cloak @click.stop
                                                 class="filter-dropdown mt-1 p-2">
                                                <div class="text-xs font-medium text-slate-600 mb-1">筛选: <span x-text="col.name"></span></div>
                                                <label class="flex items-center gap-2 py-1 text-xs cursor-pointer hover:bg-slate-50">
                                                    <input type="checkbox" 
                                                           :checked="isAllSelected(col.name)" 
                                                           @change="toggleSelectAll(col.name)" 
                                                           class="rounded">
                                                    <span>全选</span>
                                                </label>
                                                <div class="border-t border-slate-100 my-1"></div>
                                                <template x-for="value in getUniqueValues(col.name)" :key="value">
                                                    <label class="flex items-center gap-2 py-1 text-xs cursor-pointer hover:bg-slate-50">
                                                        <input type="checkbox" 
                                                               :value="value" 
                                                               :checked="(columnFilters[col.name] || []).includes(value)"
                                                               @change="toggleFilterValue(col.name, value)"
                                                               class="rounded">
                                                        <span x-text="value || '(空)'" class="truncate"></span>
                                                    </label>
                                                </template>
                                                <div class="border-t border-slate-100 my-1"></div>
                                                <button @click="clearFilter(col.name)" class="w-full text-xs text-red-500 hover:bg-red-50 py-1 rounded">清除筛选</button>
                                            </div>
                                            <!-- 列宽调整手柄 -->
                                            <div class="resize-handle" @mousedown="startResize($event, index)"></div>
                                        </th>
                                    </template>
                                    <th class="w-24" style="min-width: 80px;">
                                        <input x-show="addingColumn" 
                                               x-model="newColumnName" 
                                               @blur="confirmAddColumn()" 
                                               @keydown.enter="confirmAddColumn()"
                                               @keydown.escape="addingColumn = false"
                                               x-ref="newColInput"
                                               class="w-full text-xs px-1 py-0.5 border border-blue-400 rounded"
                                               placeholder="列名">
                                        <button x-show="!addingColumn" @click="startAddColumn()" class="text-blue-500 hover:text-blue-700 text-xs font-medium flex items-center gap-1">
                                            <i class="fas fa-plus text-[10px]"></i> 新增列
                                        </button>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="modelTableBody" class="divide-y divide-slate-100">
                                <template x-for="(model, index) in filteredModels" :key="model.id">
                                    <tr class="hover:bg-slate-50 transition-colors cursor-pointer sortable-row"
                                        :class="selectedModel?.id === model.id ? 'bg-blue-50' : ''"
                                        :data-model-id="model.id"
                                        @click="selectModel(model)"
                                        @contextmenu.prevent.stop="showContextMenu($event, index)">
                                        <td class="text-center cursor-move handle text-slate-400">
                                            <i class="fas fa-grip-vertical text-xs"></i>
                                        </td>
                                        <td @dblclick="editModelName(model, $event)">
                                            <div class="font-medium text-slate-800" x-show="!model.editingName" x-text="model.name"></div>
                                            <input x-show="model.editingName" 
                                                   x-model="model.name" 
                                                   @blur="saveModelName(model)"
                                                   @keydown.enter="saveModelName(model)"
                                                   class="compact-input font-medium"
                                                   type="text">
                                            <div class="text-[11px] text-slate-500" x-text="model.code"></div>
                                        </td>
                                        <template x-for="(col, colIndex) in dynamicColumns" :key="col.name">
                                            <td>
                                                <input type="text" 
                                                       x-model="model.features[col.name]" 
                                                       @click.stop
                                                       @change="saveToLocalStorage()"
                                                       class="compact-input"
                                                       placeholder="-">
                                            </td>
                                        </template>
                                        <td></td>
                                    </tr>
                                </template>
                                
                                <!-- 新增行 -->
                                <tr class="bg-slate-50/50 hover:bg-slate-100 cursor-pointer transition-colors" 
                                    @click="addNewRow()"
                                    id="addNewRowBtn">
                                    <td class="text-center text-slate-400">
                                        <i class="fas fa-plus text-xs"></i>
                                    </td>
                                    <td colspan="100%" class="text-slate-500 text-xs py-2">
                                        点击添加新型号...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div x-show="currentModels.length === 0 && selectedSeries" class="p-6 text-center text-slate-400 text-xs">
                        暂无型号数据，点击下方添加
                    </div>
                </div>
                
                <div x-show="!selectedSeries" class="flex items-center justify-center h-64 text-slate-400 text-xs">
                    <div class="text-center">
                        <i class="fas fa-arrow-left text-2xl mb-2 text-slate-300"></i>
                        <p>请从左侧选择具体系列</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- 第三部分：改型详情 -->
        <aside x-show="selectedModel" x-transition class="w-80 bg-white border-l border-slate-200 flex flex-col shadow-sm z-10">
            <div class="p-3 border-b border-slate-100 bg-slate-50/50 flex items-center justify-between">
                <h3 class="font-semibold text-slate-700 text-sm flex items-center gap-1.5">
                    <i class="fas fa-info-circle text-blue-500"></i> 改型详情
                </h3>
                <button @click="selectedModel = null" class="w-6 h-6 hover:bg-slate-200 rounded flex items-center justify-center text-slate-500">
                    <i class="fas fa-times text-xs"></i>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-3" x-show="selectedModel">
                <!-- 系列总图 -->
                <div class="mb-3">
                    <label class="block text-xs font-medium text-slate-700 mb-1">系列总图</label>
                    <div class="bg-slate-50 rounded-lg p-2 text-center cursor-pointer border border-slate-200 hover:border-blue-400 transition-colors relative"
                         @click="selectedModel.seriesImage ? showImageModal = true : $refs.seriesImage.click()"
                         @dragover.prevent="$event.currentTarget.classList.add('border-blue-400', 'bg-blue-50')"
                         @dragleave.prevent="$event.currentTarget.classList.remove('border-blue-400', 'bg-blue-50')"
                         @drop.prevent="handleImageDrop($event)">
                        <input type="file" x-ref="seriesImage" class="hidden" accept="image/*" @change="handleImageUpload($event)">
                        <template x-if="selectedModel?.seriesImage">
                            <img :src="selectedModel.seriesImage" class="w-full h-32 object-contain rounded">
                        </template>
                        <template x-if="!selectedModel?.seriesImage">
                            <div class="py-6 text-slate-400">
                                <i class="fas fa-cloud-upload-alt text-2xl mb-1"></i>
                                <p class="text-xs">点击或拖拽上传</p>
                            </div>
                        </template>
                        <button x-show="selectedModel?.seriesImage" @click.stop="selectedModel.seriesImage = null; saveToLocalStorage()" 
                                class="absolute top-1 right-1 w-5 h-5 bg-red-500 text-white rounded-full flex items-center justify-center text-[10px] hover:bg-red-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <p x-show="selectedModel?.seriesImage" class="text-[10px] text-slate-500 mt-1 text-center">点击图片放大查看</p>
                </div>

                <!-- 壳体号及改型 -->
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <label class="block text-xs font-medium text-slate-700">壳体号及改型</label>
                    </div>
                    
                    <!-- 内嵌添加壳体号 -->
                    <div class="shell-add-inline" x-show="addingShell" x-cloak>
                        <input type="text" 
                               x-model="newShellCode" 
                               @keydown.enter="confirmAddShell()"
                               @blur="confirmAddShell()"
                               x-ref="shellInput"
                               class="compact-input flex-1"
                               placeholder="输入壳体号 (如: A)">
                        <button @click="cancelAddShell()" class="text-slate-400 hover:text-slate-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <button x-show="!addingShell" 
                            @click="startAddShell()" 
                            class="w-full py-2 bg-blue-50 hover:bg-blue-100 text-blue-600 rounded-lg text-xs font-medium flex items-center justify-center gap-1 transition-colors mb-3">
                        <i class="fas fa-plus text-[10px]"></i> 添加壳体号
                    </button>
                    
                    <div class="space-y-2">
                        <template x-for="(shell, shellIndex) in selectedModel?.shells || []" :key="shellIndex">
                            <div class="bg-slate-50 rounded-lg border border-slate-200 overflow-hidden">
                                <!-- 壳体号标题 -->
                                <div class="flex items-center justify-between px-2 py-1.5 bg-slate-100 border-b border-slate-200">
                                    <span class="font-bold text-slate-700 text-sm" x-text="shell.code"></span>
                                    <button @click="removeShellType(shellIndex)" class="text-red-400 hover:text-red-600 w-5 h-5 flex items-center justify-center">
                                        <i class="fas fa-times text-[10px]"></i>
                                    </button>
                                </div>
                                
                                <!-- 改型列表 -->
                                <div class="divide-y divide-slate-100">
                                    <template x-for="(variant, varIndex) in shell.variants" :key="varIndex">
                                        <div class="variant-row">
                                            <input type="text" x-model="variant.model" placeholder="具体型号" 
                                                   class="compact-input font-medium text-slate-700"
                                                   @change="saveToLocalStorage()">
                                            <input type="text" x-model="variant.uniqueId" placeholder="唯一编号" 
                                                   class="compact-input text-[11px] text-slate-500 font-mono"
                                                   @change="saveToLocalStorage()">
                                            <button @click="removeVariant(shell, varIndex)" class="text-red-400 hover:text-red-600 w-5 h-5 flex items-center justify-center">
                                                <i class="fas fa-times text-[10px]"></i>
                                            </button>
                                        </div>
                                    </template>
                                    
                                    <!-- 添加改型按钮 -->
                                    <div class="px-2 py-1.5 bg-white cursor-pointer hover:bg-slate-50 transition-colors text-center"
                                         @click="addVariant(shell)">
                                        <span class="text-[11px] text-blue-500 font-medium">
                                            <i class="fas fa-plus text-[8px]"></i> 添加改型
                                        </span>
                                    </div>
                                    
                                    <div x-show="shell.variants.length === 0" class="px-2 py-2 text-[11px] text-slate-400 text-center">
                                        暂无改型
                                    </div>
                                </div>
                            </div>
                        </template>
                        
                        <div x-show="!selectedModel?.shells || selectedModel.shells.length === 0" class="text-center py-4 text-slate-400 text-xs bg-slate-50 rounded-lg border border-dashed border-slate-200">
                            暂无壳体号，点击上方按钮添加
                        </div>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- 图片放大模态框 -->
    <div x-show="showImageModal && selectedModel?.seriesImage" x-cloak x-transition class="image-modal" @click="showImageModal = false">
        <img :src="selectedModel.seriesImage" @click.stop>
    </div>

    <!-- 右键菜单 -->
    <div x-show="contextMenu.show" x-cloak 
         class="context-menu" 
         :style="`left: ${contextMenu.x}px; top: ${contextMenu.y}px`"
         @click.stop>
        <div class="context-menu-item text-blue-600" @click="addRowAt(contextMenu.index, 'above')">
            <i class="fas fa-arrow-up text-xs"></i> 上方添加行
        </div>
        <div class="context-menu-item text-blue-600" @click="addRowAt(contextMenu.index, 'below')">
            <i class="fas fa-arrow-down text-xs"></i> 下方添加行
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item text-red-500" @click="deleteRowAt(contextMenu.index)">
            <i class="fas fa-trash text-xs"></i> 删除此行
        </div>
    </div>

    <script>
        function modelManager() {
            return {
                categories: [],
                models: [],
                dynamicColumns: [
                    { name: '镀层', width: 80 },
                    { name: '防护等级', width: 90 },
                    { name: '电压', width: 70 },
                    { name: '电流', width: 70 },
                    { name: '耐插拔', width: 80 }
                ],
                selectedSeries: null,
                selectedModel: null,
                sidebarCollapsed: false,
                showImageModal: false,
                
                // 筛选状态 - 改为对象存储每个列的选中值数组
                columnFilters: {},
                activeFilter: null,
                
                // 新增列
                addingColumn: false,
                newColumnName: '',
                
                // 内联编辑
                editingId: null,
                editingName: '',
                
                // 右键菜单
                contextMenu: { show: false, x: 0, y: 0, index: null },
                
                // 壳体号内嵌添加
                addingShell: false,
                newShellCode: '',
                
                // 列宽调整
                resizingCol: null,
                startX: 0,
                startWidth: 0,
                
                init() {
                    this.loadFromLocalStorage();
                    if (this.categories.length === 0) {
                        this.initSampleData();
                    }
                    this.$nextTick(() => {
                        this.initSortable();
                        this.initColumnResize();
                    });
                },
                
                initSampleData() {
                    this.categories = [
                        {
                            id: '1',
                            name: '防务连接器',
                            type: 'folder',
                            expanded: true,
                            children: [
                                {
                                    id: '1-1',
                                    name: '圆形连接器',
                                    type: 'folder',
                                    expanded: true,
                                    children: [
                                        { id: '1-1-1', name: '599大系列', type: 'series', expanded: false, children: [] }
                                    ]
                                }
                            ]
                        },
                        {
                            id: '2',
                            name: '工业连接器',
                            type: 'folder',
                            expanded: false,
                            children: [
                                {
                                    id: '2-1',
                                    name: '车载连接器',
                                    type: 'folder',
                                    expanded: false,
                                    children: [
                                        {
                                            id: '2-1-1',
                                            name: '电池连接器',
                                            type: 'folder',
                                            expanded: false,
                                            children: [
                                                { id: '2-1-1-1', name: 'XC158系列', type: 'series', expanded: false, children: [] }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    ];
                    
                    this.models = [
                        {
                            id: 'm1',
                            seriesId: '1-1-1',
                            name: '599-YX系列',
                            code: '599-YX',
                            order: 0,
                            features: { '镀层': '镀金', '防护等级': 'IP67', '电压': '500V', '电流': '13A', '耐插拔': '500次' },
                            seriesImage: null,
                            shells: [
                                { code: 'A', variants: [{ model: '599-A-YX', uniqueId: '21E5-9014-13468' }] }
                            ],
                            editingName: false
                        }
                    ];
                    
                    this.saveToLocalStorage();
                },
                
                // 递归渲染树形节点
                renderTreeItem(item, index, parentArray, level = 0) {
                    const isFolder = item.type === 'folder';
                    const hasChildren = item.children && item.children.length > 0;
                    const indent = level * 16;
                    
                    let html = '';
                    
                    html += `<div class="tree-item" style="margin-left: ${indent}px">`;
                    html += `<div class="tree-node">`;
                    
                    if (isFolder) {
                        // 文件夹节点
                        html += `<div class="flex items-center gap-1 py-1 px-1.5 rounded hover:bg-slate-100 transition-colors ${item.expanded ? 'folder-expanded' : ''}">`;
                        
                        html += `<button @click="toggleExpand(findItemById('${item.id}'))" 
                                  class="w-4 h-4 flex items-center justify-center text-slate-400 hover:text-slate-600 transition-transform"
                                  :class="findItemById('${item.id}')?.expanded ? 'rotate-90' : ''">`;
                        html += `<i class="fas fa-chevron-right text-[10px]"></i>`;
                        html += `</button>`;
                        
                        html += `<div class="flex-1 flex items-center gap-1.5 min-w-0" @dblclick="startEdit(findItemById('${item.id}'))">`;
                        html += `<i class="fas ${item.expanded ? 'fa-folder-open text-blue-400' : 'fa-folder text-blue-300'}" style="font-size: 11px;"></i>`;
                        
                        // 编辑输入框
                        html += `<input x-show="editingId === '${item.id}'" 
                                       x-model="editingName"
                                       @blur="saveEdit(findItemById('${item.id}'))"
                                       @keydown.enter="saveEdit(findItemById('${item.id}'))"
                                       @keydown.escape="cancelEdit()"
                                       class="inline-input"
                                       type="text">`;
                        
                        html += `<span x-show="editingId !== '${item.id}'" 
                                      x-text="findItemById('${item.id}')?.name" 
                                      class="flex-1 text-[13px] truncate"></span>`;
                        html += `</div>`;
                        
                        html += `<div class="tree-actions flex items-center gap-0.5">`;
                        html += `<button @click="addFolder(findItemById('${item.id}'))" class="w-5 h-5 hover:bg-blue-100 rounded flex items-center justify-center text-blue-500" title="添加子文件夹">
                                    <i class="fas fa-folder-plus text-[10px]"></i>
                                 </button>`;
                        html += `<button @click="addSeries(findItemById('${item.id}'))" class="w-5 h-5 hover:bg-green-100 rounded flex items-center justify-center text-green-500" title="添加系列">
                                    <i class="fas fa-microchip text-[10px]"></i>
                                 </button>`;
                        html += `<button @click="insertBefore(findParentArray('${item.id}'), findItemIndex('${item.id}'))" class="w-5 h-5 hover:bg-slate-200 rounded flex items-center justify-center text-slate-400">
                                    <i class="fas fa-level-up-alt text-[10px]"></i>
                                 </button>`;
                        html += `<button @click="deleteItem(findParentArray('${item.id}'), findItemIndex('${item.id}'))" class="w-5 h-5 hover:bg-red-100 rounded flex items-center justify-center text-red-400">
                                    <i class="fas fa-trash text-[10px]"></i>
                                 </button>`;
                        html += `</div>`;
                        html += `</div>`;
                        
                        // 子节点
                        if (hasChildren) {
                            html += `<div x-show="findItemById('${item.id}')?.expanded" x-collapse class="tree-children space-y-0.5 mt-0.5">`;
                            item.children.forEach((child, childIndex) => {
                                html += this.renderTreeItem(child, childIndex, item.children, level + 1);
                            });
                            html += `</div>`;
                        }
                    } else {
                        // 系列节点
                        html += `<div class="flex items-center gap-1 py-1 px-1.5 rounded hover:bg-slate-100 transition-colors cursor-pointer min-w-0 ${this.selectedSeries?.id === item.id ? 'series-selected' : ''}"
                                  @click="selectSeries(findItemById('${item.id}'))">`;
                        html += `<div class="w-4"></div>`;
                        
                        html += `<div class="flex-1 flex items-center gap-1.5 min-w-0" @dblclick.stop="startEdit(findItemById('${item.id}'))">`;
                        html += `<i class="fas fa-microchip ${this.selectedSeries?.id === item.id ? 'text-blue-500' : 'text-slate-400'}" style="font-size: 11px;"></i>`;
                        
                        html += `<input x-show="editingId === '${item.id}'" 
                                       x-model="editingName"
                                       @blur="saveEdit(findItemById('${item.id}'))"
                                       @keydown.enter="saveEdit(findItemById('${item.id}'))"
                                       @keydown.escape="cancelEdit()"
                                       class="inline-input"
                                       type="text">`;
                        
                        html += `<span x-show="editingId !== '${item.id}'" 
                                      x-text="findItemById('${item.id}')?.name" 
                                      class="flex-1 text-[13px] truncate font-medium"></span>`;
                        html += `</div>`;
                        
                        html += `<div class="tree-actions flex items-center gap-0.5">`;
                        html += `<button @click.stop="insertBefore(findParentArray('${item.id}'), findItemIndex('${item.id}'))" class="w-5 h-5 hover:bg-slate-200 rounded flex items-center justify-center text-slate-400">
                                    <i class="fas fa-level-up-alt text-[10px]"></i>
                                 </button>`;
                        html += `<button @click.stop="deleteItem(findParentArray('${item.id}'), findItemIndex('${item.id}'))" class="w-5 h-5 hover:bg-red-100 rounded flex items-center justify-center text-red-400">
                                    <i class="fas fa-trash text-[10px]"></i>
                                 </button>`;
                        html += `</div>`;
                        html += `</div>`;
                    }
                    
                    html += `</div>`;
                    html += `</div>`;
                    
                    return html;
                },
                
                // 辅助函数
                findItemById(id, items = this.categories) {
                    for (let item of items) {
                        if (item.id === id) return item;
                        if (item.children) {
                            const found = this.findItemById(id, item.children);
                            if (found) return found;
                        }
                    }
                    return null;
                },
                
                findParentArray(id, items = this.categories, parent = null) {
                    for (let i = 0; i < items.length; i++) {
                        if (items[i].id === id) return parent || items;
                        if (items[i].children) {
                            const found = this.findParentArray(id, items[i].children, items[i].children);
                            if (found) return found;
                        }
                    }
                    return null;
                },
                
                findItemIndex(id) {
                    const parentArray = this.findParentArray(id);
                    if (!parentArray) return -1;
                    return parentArray.findIndex(item => item.id === id);
                },
                
                // 计算属性
                get currentModels() {
                    if (!this.selectedSeries) return [];
                    return this.models
                        .filter(m => m.seriesId === this.selectedSeries.id)
                        .sort((a, b) => (a.order || 0) - (b.order || 0));
                },
                
                get filteredModels() {
                    let models = this.currentModels;
                    
                    // 应用列筛选
                    Object.keys(this.columnFilters).forEach(col => {
                        const selectedValues = this.columnFilters[col];
                        if (selectedValues && selectedValues.length > 0) {
                            models = models.filter(m => {
                                const val = m.features[col] || '';
                                return selectedValues.includes(val);
                            });
                        }
                    });
                    
                    return models;
                },
                
                get breadcrumbPath() {
                    if (!this.selectedSeries) return '';
                    
                    const findPath = (items, targetId, currentPath) => {
                        for (let item of items) {
                            const newPath = [...currentPath, item.name];
                            if (item.id === targetId) {
                                return newPath;
                            }
                            if (item.children) {
                                const found = findPath(item.children, targetId, newPath);
                                if (found) return found;
                            }
                        }
                        return null;
                    };
                    
                    const result = findPath(this.categories, this.selectedSeries.id, []);
                    return result ? result.join(' > ') : '';
                },
                
                // 树形操作
                toggleExpand(item) {
                    if (item) item.expanded = !item.expanded;
                },
                
                selectSeries(series) {
                    if (!series) return;
                    this.selectedSeries = series;
                    this.selectedModel = null;
                    this.closeAllFilters();
                },
                
                startEdit(item) {
                    if (!item) return;
                    this.editingId = item.id;
                    this.editingName = item.name;
                },
                
                saveEdit(item) {
                    if (!item) return;
                    if (this.editingName.trim()) {
                        item.name = this.editingName.trim();
                        this.saveToLocalStorage();
                    }
                    this.editingId = null;
                    this.editingName = '';
                },
                
                cancelEdit() {
                    this.editingId = null;
                    this.editingName = '';
                },
                
                addFolder(parent) {
                    if (!parent) return;
                    const newFolder = {
                        id: Date.now().toString() + Math.random().toString(36).substr(2, 5),
                        name: '新建文件夹',
                        type: 'folder',
                        expanded: false,
                        children: []
                    };
                    if (!parent.children) parent.children = [];
                    parent.children.push(newFolder);
                    parent.expanded = true;
                    this.saveToLocalStorage();
                    this.$nextTick(() => {
                        this.startEdit(newFolder);
                    });
                },
                
                addSeries(parent) {
                    if (!parent) return;
                    const newSeries = {
                        id: Date.now().toString() + Math.random().toString(36).substr(2, 5),
                        name: '新建系列',
                        type: 'series',
                        expanded: false,
                        children: []
                    };
                    if (!parent.children) parent.children = [];
                    parent.children.push(newSeries);
                    parent.expanded = true;
                    this.saveToLocalStorage();
                    this.$nextTick(() => {
                        this.startEdit(newSeries);
                    });
                },
                
                addRootFolder() {
                    const newFolder = {
                        id: Date.now().toString(),
                        name: '新建领域',
                        type: 'folder',
                        expanded: false,
                        children: []
                    };
                    this.categories.push(newFolder);
                    this.saveToLocalStorage();
                    this.$nextTick(() => {
                        this.startEdit(newFolder);
                    });
                },
                
                insertBefore(array, index) {
                    if (!array || index < 0) return;
                    const newItem = {
                        id: Date.now().toString() + Math.random().toString(36).substr(2, 5),
                        name: '新建项',
                        type: 'folder',
                        expanded: false,
                        children: []
                    };
                    array.splice(index, 0, newItem);
                    this.saveToLocalStorage();
                    this.$nextTick(() => {
                        this.startEdit(newItem);
                    });
                },
                
                deleteItem(array, index) {
                    if (!array || index < 0) return;
                    const item = array[index];
                    if (!confirm(`确定删除 "${item.name}"?`)) return;
                    array.splice(index, 1);
                    if (this.selectedSeries?.id === item.id) {
                        this.selectedSeries = null;
                        this.selectedModel = null;
                    }
                    this.saveToLocalStorage();
                },
                
                // 表格排序和列宽调整初始化
                initSortable() {
                    const tbody = document.getElementById('modelTableBody');
                    const headerRow = document.getElementById('tableHeader');
                    
                    // 行排序 - 修正：使用data属性识别行
                    if (tbody && typeof Sortable !== 'undefined') {
                        Sortable.create(tbody, {
                            handle: '.handle',
                            animation: 150,
                            ghostClass: 'sortable-ghost',
                            dragClass: 'sortable-drag',
                            onStart: (evt) => {
                                // 排除新增行按钮
                                if (evt.item.id === 'addNewRowBtn') {
                                    evt.preventDefault();
                                }
                            },
                            onMove: (evt) => {
                                // 禁止拖动到新增行按钮之后
                                return evt.related.id !== 'addNewRowBtn';
                            },
                            onEnd: (evt) => {
                                if (evt.newIndex >= this.currentModels.length) return;
                                
                                // 获取实际移动的模型ID
                                const movedId = evt.item.getAttribute('data-model-id');
                                const movedModel = this.models.find(m => m.id === movedId);
                                
                                if (!movedModel) return;
                                
                                // 重新计算所有模型的order
                                const rows = tbody.querySelectorAll('tr[data-model-id]');
                                rows.forEach((row, idx) => {
                                    const modelId = row.getAttribute('data-model-id');
                                    const model = this.models.find(m => m.id === modelId);
                                    if (model) {
                                        model.order = idx;
                                    }
                                });
                                
                                this.saveToLocalStorage();
                            }
                        });
                    }
                    
                    // 列排序 - 修正：只对动态列启用拖拽
                    if (headerRow && typeof Sortable !== 'undefined') {
                        // 先给动态列添加col-header类
                        const ths = headerRow.querySelectorAll('th');
                        ths.forEach((th, idx) => {
                            if (idx >= 2 && idx < ths.length - 1) {
                                th.classList.add('col-header');
                            }
                        });
                        
                        Sortable.create(headerRow, {
                            animation: 150,
                            handle: '.col-header',
                            ghostClass: 'sortable-ghost',
                            filter: '.handle-col, th:first-child, th:nth-child(2), th:last-child',
                            preventOnFilter: true,
                            onStart: () => {
                                this.closeAllFilters();
                            },
                            onEnd: (evt) => {
                                const ths = headerRow.querySelectorAll('th');
                                let oldDynamicIdx = -1;
                                let newDynamicIdx = -1;
                                
                                // 计算动态列的实际索引
                                let dynamicCount = 0;
                                ths.forEach((th, idx) => {
                                    if (idx >= 2 && idx < ths.length - 1) {
                                        if (idx === evt.oldIndex) oldDynamicIdx = dynamicCount;
                                        if (idx === evt.newIndex) newDynamicIdx = dynamicCount;
                                        dynamicCount++;
                                    }
                                });
                                
                                if (oldDynamicIdx >= 0 && newDynamicIdx >= 0 && 
                                    oldDynamicIdx < this.dynamicColumns.length && 
                                    newDynamicIdx < this.dynamicColumns.length) {
                                    const moved = this.dynamicColumns.splice(oldDynamicIdx, 1)[0];
                                    this.dynamicColumns.splice(newDynamicIdx, 0, moved);
                                    this.saveToLocalStorage();
                                }
                            }
                        });
                    }
                },
                
                // 列宽调整
                initColumnResize() {
                    const table = document.getElementById('modelTable');
                    if (!table) return;
                    
                    document.addEventListener('mousemove', (e) => {
                        if (this.resizingCol !== null) {
                            const diff = e.clientX - this.startX;
                            const newWidth = Math.max(60, this.startWidth + diff);
                            if (this.dynamicColumns[this.resizingCol]) {
                                this.dynamicColumns[this.resizingCol].width = newWidth;
                            }
                        }
                    });
                    
                    document.addEventListener('mouseup', () => {
                        if (this.resizingCol !== null) {
                            this.resizingCol = null;
                            this.saveToLocalStorage();
                        }
                    });
                },
                
                startResize(e, colIndex) {
                    e.stopPropagation();
                    e.preventDefault();
                    this.resizingCol = colIndex;
                    this.startX = e.clientX;
                    this.startWidth = this.dynamicColumns[colIndex].width || 100;
                },
                
                // 系列型号改名
                editModelName(model, event) {
                    event.stopPropagation();
                    model.editingName = true;
                    this.$nextTick(() => {
                        const input = event.currentTarget.querySelector('input');
                        if (input) {
                            input.focus();
                            input.select();
                        }
                    });
                },
                
                saveModelName(model) {
                    model.editingName = false;
                    this.saveToLocalStorage();
                },
                
                // 列操作
                startAddColumn() {
                    this.addingColumn = true;
                    this.newColumnName = '';
                    this.$nextTick(() => {
                        if (this.$refs.newColInput) this.$refs.newColInput.focus();
                    });
                },
                
                confirmAddColumn() {
                    if (this.newColumnName.trim()) {
                        this.dynamicColumns.push({ 
                            name: this.newColumnName.trim(),
                            width: 100 
                        });
                        this.saveToLocalStorage();
                        this.$nextTick(() => {
                            this.initSortable();
                        });
                    }
                    this.addingColumn = false;
                    this.newColumnName = '';
                },
                
                // 筛选功能 - 修正：使用独立的toggle方法
                toggleFilter(colName) {
                    this.activeFilter = this.activeFilter === colName ? null : colName;
                },
                
                closeAllFilters() {
                    this.activeFilter = null;
                },
                
                getUniqueValues(colName) {
                    const values = new Set();
                    this.currentModels.forEach(m => {
                        values.add(m.features[colName] || '');
                    });
                    return Array.from(values).sort();
                },
                
                isAllSelected(colName) {
                    const values = this.getUniqueValues(colName);
                    const selected = this.columnFilters[colName] || [];
                    return values.length > 0 && values.length === selected.length;
                },
                
                toggleSelectAll(colName) {
                    const values = this.getUniqueValues(colName);
                    const current = this.columnFilters[colName] || [];
                    
                    if (this.isAllSelected(colName)) {
                        // 如果已全选，则清空
                        this.columnFilters[colName] = [];
                    } else {
                        // 否则全选
                        this.columnFilters[colName] = [...values];
                    }
                },
                
                toggleFilterValue(colName, value) {
                    // 初始化数组如果不存在
                    if (!this.columnFilters[colName]) {
                        this.columnFilters[colName] = [];
                    }
                    
                    const idx = this.columnFilters[colName].indexOf(value);
                    if (idx > -1) {
                        // 已选中，移除
                        this.columnFilters[colName].splice(idx, 1);
                    } else {
                        // 未选中，添加
                        this.columnFilters[colName].push(value);
                    }
                },
                
                clearFilter(colName) {
                    delete this.columnFilters[colName];
                    this.activeFilter = null;
                },
                
                // 行操作
                addNewRow() {
                    const newModel = {
                        id: 'm' + Date.now(),
                        seriesId: this.selectedSeries.id,
                        name: '新型号',
                        code: 'NEW',
                        order: this.currentModels.length,
                        features: {},
                        seriesImage: null,
                        shells: [],
                        editingName: false
                    };
                    this.models.push(newModel);
                    this.saveToLocalStorage();
                    
                    this.$nextTick(() => {
                        const rows = document.querySelectorAll('#modelTableBody tr[data-model-id]');
                        const lastRow = rows[rows.length - 1];
                        if (lastRow) {
                            const firstInput = lastRow.querySelector('input');
                            if (firstInput) {
                                firstInput.focus();
                                firstInput.select();
                            }
                        }
                    });
                },
                
                // 右键菜单
                showContextMenu(event, index) {
                    event.preventDefault();
                    event.stopPropagation();
                    
                    this.contextMenu = {
                        show: true,
                        x: event.clientX,
                        y: event.clientY,
                        index: index
                    };
                },
                
                hideContextMenu() {
                    this.contextMenu.show = false;
                },
                
                addRowAt(index, position) {
                    const newModel = {
                        id: 'm' + Date.now(),
                        seriesId: this.selectedSeries.id,
                        name: '新型号',
                        code: 'NEW',
                        order: 0,
                        features: {},
                        seriesImage: null,
                        shells: [],
                        editingName: false
                    };
                    
                    const models = this.currentModels;
                    const insertIdx = position === 'above' ? index : index + 1;
                    
                    const targetModel = models[index];
                    const allModelsIdx = this.models.findIndex(m => m.id === targetModel.id);
                    const actualInsertIdx = position === 'above' ? allModelsIdx : allModelsIdx + 1;
                    
                    this.models.splice(actualInsertIdx, 0, newModel);
                    
                    // 重新排序
                    this.currentModels.forEach((m, idx) => m.order = idx);
                    
                    this.saveToLocalStorage();
                    this.hideContextMenu();
                    
                    this.$nextTick(() => {
                        const rows = document.querySelectorAll('#modelTableBody tr[data-model-id]');
                        const targetRow = rows[insertIdx];
                        if (targetRow) {
                            const firstInput = targetRow.querySelector('input');
                            if (firstInput) {
                                firstInput.focus();
                                firstInput.select();
                            }
                        }
                    });
                },
                
                deleteRowAt(index) {
                    if (!confirm('确定删除此行?')) {
                        this.hideContextMenu();
                        return;
                    }
                    const model = this.currentModels[index];
                    this.models = this.models.filter(m => m.id !== model.id);
                    if (this.selectedModel?.id === model.id) this.selectedModel = null;
                    
                    this.currentModels.forEach((m, idx) => m.order = idx);
                    
                    this.saveToLocalStorage();
                    this.hideContextMenu();
                },
                
                selectModel(model) {
                    this.selectedModel = model;
                    this.closeAllFilters();
                },
                
                // 壳体号内嵌添加
                startAddShell() {
                    this.addingShell = true;
                    this.newShellCode = '';
                    this.$nextTick(() => {
                        if (this.$refs.shellInput) this.$refs.shellInput.focus();
                    });
                },
                
                confirmAddShell() {
                    if (this.newShellCode.trim()) {
                        if (!this.selectedModel.shells) this.selectedModel.shells = [];
                        this.selectedModel.shells.push({ 
                            code: this.newShellCode.trim(), 
                            variants: [] 
                        });
                        this.saveToLocalStorage();
                    }
                    this.addingShell = false;
                    this.newShellCode = '';
                },
                
                cancelAddShell() {
                    this.addingShell = false;
                    this.newShellCode = '';
                },
                
                removeShellType(index) {
                    if (!confirm('删除此壳体号?')) return;
                    this.selectedModel.shells.splice(index, 1);
                    this.saveToLocalStorage();
                },
                
                addVariant(shell) {
                    shell.variants.push({ model: '', uniqueId: '' });
                    this.saveToLocalStorage();
                },
                
                removeVariant(shell, index) {
                    shell.variants.splice(index, 1);
                    this.saveToLocalStorage();
                },
                
                // 图片
                handleImageUpload(event) {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            this.selectedModel.seriesImage = e.target.result;
                            this.saveToLocalStorage();
                        };
                        reader.readAsDataURL(file);
                    }
                },
                
                handleImageDrop(event) {
                    event.currentTarget.classList.remove('border-blue-400', 'bg-blue-50');
                    const file = event.dataTransfer.files[0];
                    if (file?.type?.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            this.selectedModel.seriesImage = e.target.result;
                            this.saveToLocalStorage();
                        };
                        reader.readAsDataURL(file);
                    }
                },
                
                // CSV 导出导入
                exportCSV() {
                    if (!this.selectedSeries) {
                        alert('请先选择系列');
                        return;
                    }
                    
                    const headers = ['型号名称', '型号编码', ...this.dynamicColumns.map(c => c.name)];
                    const rows = this.currentModels.map(m => [
                        m.name,
                        m.code,
                        ...this.dynamicColumns.map(c => m.features[c.name] || '')
                    ]);
                    
                    const csvContent = [
                        headers.join(','),
                        ...rows.map(row => row.map(cell => `"${(cell || '').toString().replace(/"/g, '""')}"`).join(','))
                    ].join('\n');
                    
                    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `${this.selectedSeries.name}_型号数据.csv`;
                    link.click();
                    URL.revokeObjectURL(link.href);
                },
                
                importCSV(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const text = e.target.result;
                        const lines = text.split('\n').filter(l => l.trim());
                        if (lines.length < 2) {
                            alert('CSV文件格式错误');
                            return;
                        }
                        
                        const headers = this.parseCSVLine(lines[0]);
                        const nameIdx = headers.indexOf('型号名称');
                        const codeIdx = headers.indexOf('型号编码');
                        
                        if (nameIdx === -1 || codeIdx === -1) {
                            alert('CSV必须包含"型号名称"和"型号编码"列');
                            return;
                        }
                        
                        const dynamicColIndices = this.dynamicColumns.map(col => ({
                            col: col,
                            idx: headers.indexOf(col.name)
                        })).filter(item => item.idx !== -1);
                        
                        let imported = 0;
                        for (let i = 1; i < lines.length; i++) {
                            const values = this.parseCSVLine(lines[i]);
                            if (values.length < 2) continue;
                            
                            const features = {};
                            dynamicColIndices.forEach(({ col, idx }) => {
                                if (idx < values.length) {
                                    features[col.name] = values[idx];
                                }
                            });
                            
                            this.models.push({
                                id: 'm' + Date.now() + '_' + i,
                                seriesId: this.selectedSeries.id,
                                name: values[nameIdx] || '',
                                code: values[codeIdx] || '',
                                order: this.currentModels.length + imported,
                                features: features,
                                seriesImage: null,
                                shells: [],
                                editingName: false
                            });
                            imported++;
                        }
                        
                        this.saveToLocalStorage();
                        alert(`成功导入 ${imported} 条数据`);
                    };
                    reader.readAsText(file);
                    event.target.value = '';
                },
                
                parseCSVLine(line) {
                    const result = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        const nextChar = line[i + 1];
                        
                        if (char === '"') {
                            if (inQuotes && nextChar === '"') {
                                current += '"';
                                i++;
                            } else {
                                inQuotes = !inQuotes;
                            }
                        } else if (char === ',' && !inQuotes) {
                            result.push(current.trim());
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    result.push(current.trim());
                    return result;
                },
                
                // 数据持久化
                saveToLocalStorage() {
                    localStorage.setItem('modelManagerData_v6', JSON.stringify({
                        categories: this.categories,
                        models: this.models,
                        dynamicColumns: this.dynamicColumns,
                        columnFilters: this.columnFilters
                    }));
                },
                
                loadFromLocalStorage() {
                    const saved = localStorage.getItem('modelManagerData_v6');
                    if (saved) {
                        try {
                            const data = JSON.parse(saved);
                            this.categories = data.categories || [];
                            this.models = data.models || [];
                            if (data.dynamicColumns) this.dynamicColumns = data.dynamicColumns;
                            if (data.columnFilters) this.columnFilters = data.columnFilters;
                        } catch (e) {
                            console.error('加载失败', e);
                        }
                    }
                }
            }
        }
    </script>
</body>
</html>